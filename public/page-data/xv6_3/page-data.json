{"componentChunkName":"component---src-templates-post-template-tsx","path":"/xv6_3/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p><em>해당 포스트는 MIT의 교육용 운영체제 XV6를 활용하며, 코드 저작권은 MIT에 있음을 밝힙니다.</em></p>\n<h2 id=\"목표\" style=\"position:relative;\"><a href=\"#%EB%AA%A9%ED%91%9C\" aria-label=\"목표 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>목표</h2>\n<h3 id=\"virtual-memory에-해당하는-mmap-함수-구현하기\" style=\"position:relative;\"><a href=\"#virtual-memory%EC%97%90-%ED%95%B4%EB%8B%B9%ED%95%98%EB%8A%94-mmap-%ED%95%A8%EC%88%98-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\" aria-label=\"virtual memory에 해당하는 mmap 함수 구현하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Virtual memory에 해당하는 mmap() 함수 구현하기</h3>\n<h2 id=\"과정\" style=\"position:relative;\"><a href=\"#%EA%B3%BC%EC%A0%95\" aria-label=\"과정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>과정</h2>\n<h4 id=\"0-usyss-에-시스템-콜-추가\" style=\"position:relative;\"><a href=\"#0-usyss-%EC%97%90-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EC%BD%9C-%EC%B6%94%EA%B0%80\" aria-label=\"0 usyss 에 시스템 콜 추가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>0. usys.S 에 시스템 콜 추가</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\n<span class=\"token function\">SYSCALL</span><span class=\"token punctuation\">(</span>ps<span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">SYSCALL</span><span class=\"token punctuation\">(</span>mmap<span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">SYSCALL</span><span class=\"token punctuation\">(</span>munmap<span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">SYSCALL</span><span class=\"token punctuation\">(</span>freemem<span class=\"token punctuation\">)</span></code></pre></div>\n<h4 id=\"1userh에-함수-추가\" style=\"position:relative;\"><a href=\"#1userh%EC%97%90-%ED%95%A8%EC%88%98-%EC%B6%94%EA%B0%80\" aria-label=\"1userh에 함수 추가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.user.h에 함수 추가</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\nuint <span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span> <span class=\"token function\">munmap</span><span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span> <span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4 id=\"2syscallh-에-코드-추가\" style=\"position:relative;\"><a href=\"#2syscallh-%EC%97%90-%EC%BD%94%EB%93%9C-%EC%B6%94%EA%B0%80\" aria-label=\"2syscallh 에 코드 추가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.syscall.h 에 코드 추가</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SYS_mmap</span>  <span class=\"token expression\"><span class=\"token number\">25</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SYS_munmap</span>  <span class=\"token expression\"><span class=\"token number\">26</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SYS_freemem</span>  <span class=\"token expression\"><span class=\"token number\">27</span></span></span></code></pre></div>\n<h4 id=\"3syscallc에-코드-추가\" style=\"position:relative;\"><a href=\"#3syscallc%EC%97%90-%EC%BD%94%EB%93%9C-%EC%B6%94%EA%B0%80\" aria-label=\"3syscallc에 코드 추가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.syscall.c에 코드 추가</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">sys_mmap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">sys_munmap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">sys_freemem</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4 id=\"4-sysprocc에-함수-추가\" style=\"position:relative;\"><a href=\"#4-sysprocc%EC%97%90-%ED%95%A8%EC%88%98-%EC%B6%94%EA%B0%80\" aria-label=\"4 sysprocc에 함수 추가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. sysproc.c에 함수 추가</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\n<span class=\"token keyword\">int</span> \r\n<span class=\"token function\">sys_mmap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> \r\n<span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">//uint mmap(uint addr, int length, int prot, int flags, int fd, int offset)</span>\r\n  <span class=\"token keyword\">int</span> addr<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> length<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> prot<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> flags<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> offset<span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span><span class=\"token function\">argint</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>addr<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span><span class=\"token function\">argint</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>length<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span><span class=\"token function\">argint</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>prot<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span><span class=\"token function\">argint</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>flags<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span><span class=\"token function\">argint</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>fd<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span><span class=\"token function\">argint</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  \r\n  <span class=\"token keyword\">return</span> <span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">,</span> prot<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">,</span> fd<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">int</span>\r\n<span class=\"token function\">sys_munmap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">int</span> addr<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">argint</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>addr<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token function\">munmap</span><span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">int</span>\r\n<span class=\"token function\">sys_freemem</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>각 전달되는 인자에 대해 argint()가 음수가 반환 될 시 오류값을 반환 하도록하였다.</p>\n<h4 id=\"5-paramh에-코드-추가\" style=\"position:relative;\"><a href=\"#5-paramh%EC%97%90-%EC%BD%94%EB%93%9C-%EC%B6%94%EA%B0%80\" aria-label=\"5 paramh에 코드 추가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. param.h에 코드 추가</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PROT_READ</span> <span class=\"token expression\"><span class=\"token number\">0x1</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PROT_WRITE</span> <span class=\"token expression\"><span class=\"token number\">0x2</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAP_ANONYMOUS</span> <span class=\"token expression\"><span class=\"token number\">0x1</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAP_POPULATE</span> <span class=\"token expression\"><span class=\"token number\">0x2</span></span></span></code></pre></div>\n<h4 id=\"6-vmc-변경\" style=\"position:relative;\"><a href=\"#6-vmc-%EB%B3%80%EA%B2%BD\" aria-label=\"6 vmc 변경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. vm.c 변경</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token class-name\">pte_t</span> <span class=\"token operator\">*</span>\r\n<span class=\"token function\">walkpgdir</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>va<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> alloc<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\n<span class=\"token keyword\">int</span>\r\n<span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>va<span class=\"token punctuation\">,</span> uint size<span class=\"token punctuation\">,</span> uint pa<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> perm<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략</code></pre></div>\n<p>walkpgdir()과 mappages()를 사용해야 하기에, 기존의 static을 지워서 다른 곳에서도 쓸 수 있도록 하였다.</p>\n<h4 id=\"7-defsh-추가\" style=\"position:relative;\"><a href=\"#7-defsh-%EC%B6%94%EA%B0%80\" aria-label=\"7 defsh 추가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7. defs.h 추가</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\n<span class=\"token keyword\">int</span>             <span class=\"token function\">freemc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\nuint            <span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span>             <span class=\"token function\">pfh</span><span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">,</span> uint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span>             <span class=\"token function\">munmap</span><span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span>             <span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\n<span class=\"token keyword\">int</span>             <span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>va<span class=\"token punctuation\">,</span> uint size<span class=\"token punctuation\">,</span> uint pa<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> perm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token class-name\">pte_t</span> <span class=\"token operator\">*</span>        <span class=\"token function\">walkpgdir</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>va<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> alloc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>새롭게 사용하게 되는 함수, 기존의 static을 바꾼 함수 등을 추가해 주었다.</p>\n<h4 id=\"8-typesh-수정\" style=\"position:relative;\"><a href=\"#8-typesh-%EC%88%98%EC%A0%95\" aria-label=\"8 typesh 수정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>8. types.h 수정</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\n<span class=\"token keyword\">typedef</span> uint <span class=\"token class-name\">pte_t</span><span class=\"token punctuation\">;</span>\r\n</code></pre></div>\n<p>proc.c에서 사용하게될 타입 pte_t를 추가해 준다.</p>\n<h4 id=\"9-proch\" style=\"position:relative;\"><a href=\"#9-proch\" aria-label=\"9 proch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>9. proc.h</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">mmap_area</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">file</span> <span class=\"token operator\">*</span>f<span class=\"token punctuation\">;</span>\r\n  uint addr<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> length<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> offset<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> prot<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> flags<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">proc</span> <span class=\"token operator\">*</span>p<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> is_used<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>mmap_area를 추가해 준다. 여기서 is_used 는 해당 mmap_area가 유효한지를 알려주는 변수이다.</p>\n<h4 id=\"10-procc\" style=\"position:relative;\"><a href=\"#10-procc\" aria-label=\"10 procc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10. proc.c</h4>\n<h4 id=\"101-초기-선언\" style=\"position:relative;\"><a href=\"#101-%EC%B4%88%EA%B8%B0-%EC%84%A0%EC%96%B8\" aria-label=\"101 초기 선언 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10.1. 초기 선언</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"sleeplock.h\"</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"fs.h\"</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"file.h\"</span></span>\r\n\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MMAPBASE</span> <span class=\"token expression\"><span class=\"token number\">0x40000000</span></span></span>\r\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">mmap_area</span> ma<span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>추가적으로 필요한 h파일들과 MMAPBASE, struct mmap_area ma[64]; 등을 추가해 준다. 여기서 ma는 자동으로 초기화된다. 64는 “Maximum number of mmap_area array is 64.”를 참고하였다.</p>\n<h4 id=\"102-mmap-함수-추가\" style=\"position:relative;\"><a href=\"#102-mmap-%ED%95%A8%EC%88%98-%EC%B6%94%EA%B0%80\" aria-label=\"102 mmap 함수 추가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10.2. mmap 함수 추가</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">uint \r\n<span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span>uint addr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> length<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> prot<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> flags<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> offset<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// cprintf(\"addr: %d, length: %d, prot: %d, flags: %d, fd: %d, offset: %d\\n\", addr, length, prot, flags, fd, offset);</span>\r\n  \r\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">proc</span> <span class=\"token operator\">*</span>p <span class=\"token operator\">=</span> <span class=\"token function\">myproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  uint start_addr <span class=\"token operator\">=</span> addr <span class=\"token operator\">+</span> MMAPBASE<span class=\"token punctuation\">;</span>\r\n  \r\n  <span class=\"token comment\">// cprintf(\"start_addr : %d\\n\",start_addr);</span>\r\n\r\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">file</span><span class=\"token operator\">*</span> f <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fd <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    f <span class=\"token operator\">=</span> p<span class=\"token operator\">-></span>ofile<span class=\"token punctuation\">[</span>fd<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n\r\n  <span class=\"token keyword\">int</span> anony <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> populate <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> prot_read <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> prot_write <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> mem <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n\r\n\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>flags <span class=\"token operator\">&amp;</span> MAP_ANONYMOUS<span class=\"token punctuation\">)</span> anony <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>flags <span class=\"token operator\">&amp;</span> MAP_POPULATE<span class=\"token punctuation\">)</span> populate <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prot <span class=\"token operator\">&amp;</span> PROT_READ<span class=\"token punctuation\">)</span> prot_read <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prot <span class=\"token operator\">&amp;</span> PROT_WRITE<span class=\"token punctuation\">)</span> prot_write <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> \r\n\r\n  <span class=\"token comment\">// cprintf(\"prot &amp; PROT_READ: %d prot &amp; PROT_WRITE: %d\\n\", prot &amp; PROT_READ, prot &amp; PROT_WRITE);</span>\r\n\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>anony<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>fd<span class=\"token operator\">==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// cprintf(\"error It's not anonymous, but when the fd is -1\\n\");</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>f<span class=\"token operator\">-></span>readable<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> prot_read<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// cprintf(\"error protection of the file and the prot of the parameter are different\\n\");</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>f<span class=\"token operator\">-></span>writable<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> prot_write<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// cprintf(\"error protection of the file and the prot of the parameter are different\\n\");</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n\r\n  <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>is_used <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    f <span class=\"token operator\">=</span> <span class=\"token function\">filedup</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>f <span class=\"token operator\">=</span> f<span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>addr <span class=\"token operator\">=</span> start_addr<span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>length <span class=\"token operator\">=</span> length<span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>offset <span class=\"token operator\">=</span> offset<span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>prot <span class=\"token operator\">=</span> prot<span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>flags <span class=\"token operator\">=</span> flags<span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>p <span class=\"token operator\">=</span> p<span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>is_used <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  \r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>anony<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>populate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// cprintf(\"it's not ANONY, not POPULATE\\n\");</span>\r\n    <span class=\"token keyword\">return</span> start_addr<span class=\"token punctuation\">;</span>\r\n    <span class=\"token comment\">//to page fault, late phy mem alloc</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  \r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>anony<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>populate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// cprintf(\"it's ANONY, not POPULATE\\n\");</span>\r\n    <span class=\"token keyword\">return</span> start_addr<span class=\"token punctuation\">;</span>\r\n    <span class=\"token comment\">//to page fault, late phy mem alloc</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  \r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>anony<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>populate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// cprintf(\"it's not ANONY, POPULATE\\n\");</span>\r\n    f<span class=\"token operator\">-></span>off <span class=\"token operator\">=</span> offset<span class=\"token punctuation\">;</span>\r\n    uint ptr <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>ptr<span class=\"token operator\">=</span>start_addr<span class=\"token punctuation\">;</span> ptr<span class=\"token operator\">&lt;</span>start_addr<span class=\"token operator\">+</span>length<span class=\"token punctuation\">;</span> ptr<span class=\"token operator\">+=</span>PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      mem <span class=\"token operator\">=</span> <span class=\"token function\">kalloc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mem<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token function\">fileread</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> mem<span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">int</span> perm <span class=\"token operator\">=</span> prot<span class=\"token operator\">|</span>PTE_U<span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">int</span> ret <span class=\"token operator\">=</span> <span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">,</span> <span class=\"token function\">V2P</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> perm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">return</span> start_addr<span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>anony<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>populate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// cprintf(\"it's ANONY, POPULATE\\n\");</span>\r\n    uint ptr <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>ptr<span class=\"token operator\">=</span>start_addr<span class=\"token punctuation\">;</span> ptr<span class=\"token operator\">&lt;</span>start_addr<span class=\"token operator\">+</span>length<span class=\"token punctuation\">;</span> ptr<span class=\"token operator\">+=</span>PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      mem <span class=\"token operator\">=</span> <span class=\"token function\">kalloc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mem<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">int</span> perm <span class=\"token operator\">=</span> prot<span class=\"token operator\">|</span>PTE_U<span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">int</span> ret <span class=\"token operator\">=</span> <span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">,</span> <span class=\"token function\">V2P</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> perm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">return</span> start_addr<span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token keyword\">return</span> start_addr<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>start_addr = addr + MMAPBASE;를 해준다. 그리고 fd != -1 인경우 파일을 f = p->ofile[fd]; 로 불러온다.\r\n다음으로 오류 반환값을 처리하는데, 다음과 같이 구현하였다.</p>\n<ul>\n<li>\n<p>Failed: return 0</p>\n</li>\n<li>\n<p>It’s not anonymous, but when the fd is -1 <code class=\"language-text\">if ((!anony) &amp;&amp; (fd==-1)) { return 0; }</code></p>\n</li>\n<li>\n<p>The protection of the file and the prot of the parameter are different <code class=\"language-text\">if (!(f->readable) &amp;&amp; prot_read) { return 0; }</code> <code class=\"language-text\">if (!(f->writable) &amp;&amp; prot_write) { return 0; }</code></p>\n</li>\n<li>\n<p><code class=\"language-text\">if(!mem) return 0;</code> kalloc()이 실패할 경우</p>\n</li>\n<li>\n<p><code class=\"language-text\">int ret = mappages(p->pgdir, (void*)(ptr), PGSIZE, V2P(mem), perm);</code> <code class=\"language-text\">if (ret == -1) return 0;</code> mappages가 실패할 경우</p>\n</li>\n</ul>\n<p>해당 과정이 모두 끝나면 filedup()을 진행하고 mmap_area를 할당해 준다.\r\n다음으로 flag에 대해서 다음과 같이 처리하였다.\r\nPOPULATE가 아닌 경우 따로 물리 메모리를 설정하지 않으며, mmap_area만 채워주고 start_addr 만 바로 반환한다.\r\nPOPULATE인 경우, kalloc()으로 물리 페이지 mem을 할당한 다음 0으로 채운다.\r\n이때 ANONYMOUS가 아닌 경우 fileread()를 통해 실제 파일 값을 페이지 단위로 읽어 들여서 mem에 저장하고 mappages로 페이지 테이블에 등록한다. 유저가 사용하므로 prot|PTE_U를 추가하였다.\r\nANONYMOUS인 경우, 0으로 초기화만 하고 fileread()를 제외한 나머지는 동일하게 수행한다.\r\n최종적으로는 start_addr를 리턴한다.</p>\n<h4 id=\"103-page-fault-handler-구현\" style=\"position:relative;\"><a href=\"#103-page-fault-handler-%EA%B5%AC%ED%98%84\" aria-label=\"103 page fault handler 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10.3. Page Fault Handler 구현</h4>\n<h4 id=\"1031-trapc\" style=\"position:relative;\"><a href=\"#1031-trapc\" aria-label=\"1031 trapc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10.3.1 trap.c</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>생략\r\n<span class=\"token keyword\">case</span> T_PGFLT<span class=\"token operator\">:</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">pfh</span><span class=\"token punctuation\">(</span><span class=\"token function\">rcr2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> tf<span class=\"token operator\">-></span>err<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>interrupt 14, T_PGFLT에 따라 trap.c에서 해당 케이스를 추가해 주었다. 해당 케이스에 해당하면 Page Fault Handler 함수를 호출하고, 만약 실패할 경우 -1을 리턴한다.\r\n인자로는 rcr2()와 tf->err를 준다.</p>\n<h4 id=\"1032-pfhpage-fault-handler함수-구현\" style=\"position:relative;\"><a href=\"#1032-pfhpage-fault-handler%ED%95%A8%EC%88%98-%EA%B5%AC%ED%98%84\" aria-label=\"1032 pfhpage fault handler함수 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10.3.2 pfh(Page Fault Handler)함수 구현</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> \r\n<span class=\"token function\">pfh</span><span class=\"token punctuation\">(</span>uint addr<span class=\"token punctuation\">,</span> uint err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">proc</span> <span class=\"token operator\">*</span>p <span class=\"token operator\">=</span> <span class=\"token function\">myproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> find_idx <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n\r\n\r\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> t<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>t<span class=\"token operator\">&lt;</span><span class=\"token number\">64</span><span class=\"token punctuation\">;</span>t<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>addr <span class=\"token operator\">+</span> ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> addr<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>addr <span class=\"token operator\">>=</span> ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>p <span class=\"token operator\">==</span> p<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>is_used <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n        find_idx <span class=\"token operator\">=</span> t<span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>find_idx <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">//cprintf(\"pfh error: no such address!\\n\");</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n\r\n  <span class=\"token keyword\">int</span> anony <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> prot_write <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> mem <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n\r\n\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>flags <span class=\"token operator\">&amp;</span> MAP_ANONYMOUS<span class=\"token punctuation\">)</span> anony <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>prot <span class=\"token operator\">&amp;</span> PROT_WRITE<span class=\"token punctuation\">)</span> prot_write <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> \r\n\r\n  <span class=\"token comment\">// can't write(it is read) but try to write</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>prot_write <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>err <span class=\"token operator\">&amp;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">//cprintf(\"error: can't write but try to write\\n\");</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n\r\n  <span class=\"token function\">cprintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\npage fault ... %x\\n\"</span><span class=\"token punctuation\">,</span> addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  uint start_addr <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>addr<span class=\"token punctuation\">;</span>\r\n  uint length <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\r\n  uint ptr <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>anony<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// cprintf(\"\\tit's not ANONY, POPULATE\\n\");</span>\r\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">file</span><span class=\"token operator\">*</span> f <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>f<span class=\"token punctuation\">;</span>\r\n    f<span class=\"token operator\">-></span>off <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>offset<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>ptr<span class=\"token operator\">=</span>start_addr<span class=\"token punctuation\">;</span> ptr<span class=\"token operator\">&lt;</span>start_addr<span class=\"token operator\">+</span>length<span class=\"token punctuation\">;</span> ptr<span class=\"token operator\">+=</span>PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ptr <span class=\"token operator\">&lt;=</span> addr<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>addr <span class=\"token operator\">&lt;</span> ptr <span class=\"token operator\">+</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>       \r\n        mem <span class=\"token operator\">=</span> <span class=\"token function\">kalloc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mem<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token function\">fileread</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> mem<span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">int</span> perm <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>prot <span class=\"token operator\">|</span> PTE_U<span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prot_write<span class=\"token punctuation\">)</span> perm <span class=\"token operator\">=</span> perm <span class=\"token operator\">|</span> PTE_W<span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">int</span> ret <span class=\"token operator\">=</span> <span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>ptr<span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">,</span> <span class=\"token function\">V2P</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> perm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      f<span class=\"token operator\">-></span>off<span class=\"token operator\">+=</span>PGSIZE<span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// cprintf(\"it's ANONY, POPULATE\\n\");</span>\r\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>ptr<span class=\"token operator\">=</span>start_addr<span class=\"token punctuation\">;</span> ptr<span class=\"token operator\">&lt;</span>start_addr<span class=\"token operator\">+</span>length<span class=\"token punctuation\">;</span> ptr<span class=\"token operator\">+=</span>PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ptr <span class=\"token operator\">&lt;=</span> addr<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>addr <span class=\"token operator\">&lt;</span> ptr <span class=\"token operator\">+</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>  \r\n        mem <span class=\"token operator\">=</span> <span class=\"token function\">kalloc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mem<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">int</span> perm <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>prot <span class=\"token operator\">|</span> PTE_U<span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prot_write<span class=\"token punctuation\">)</span> perm <span class=\"token operator\">=</span> perm <span class=\"token operator\">|</span> PTE_W<span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">int</span> ret <span class=\"token operator\">=</span> <span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>ptr<span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">,</span> <span class=\"token function\">V2P</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> perm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n\r\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>반복문을 돌며 mmap_area 중 addr의 범위에 맞으며 proc이 자신것과 동일하고, 사용중인 것을 찾는다. 만약 없을 경우 return -1 를 수행한다. <code class=\"language-text\">(prot_write == 0)</code> 로 쓰기가 금지되어 있는데 <code class=\"language-text\">(err &amp; 2) != 0</code> 로 쓰기를 시도한 경우(읽기가 아닌 경우) -1을 반환한다. ANONYMOUS의 여부에 따라 페이지 할당을 시작한다. 여기서, 받은 addr이 해당하는 페이지를 찾고, <code class=\"language-text\">if ((ptr &lt;= addr) &amp;&amp; (addr &lt; ptr + PGSIZE))</code>, 해당 페이지를 <code class=\"language-text\">kalloc()</code> , <code class=\"language-text\">memset()</code>, <code class=\"language-text\">fileread(f, mem, PGSIZE)</code>, <code class=\"language-text\">mappages()</code> 처리를 해준다. 이때, <code class=\"language-text\">if (prot_write) perm = perm | PTE_W;</code> 를 수행하였다.</p>\n<h4 id=\"104-munmap-구현\" style=\"position:relative;\"><a href=\"#104-munmap-%EA%B5%AC%ED%98%84\" aria-label=\"104 munmap 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10.4. munmap() 구현</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> \r\n<span class=\"token function\">munmap</span><span class=\"token punctuation\">(</span>uint addr<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">proc</span> <span class=\"token operator\">*</span>p <span class=\"token operator\">=</span> <span class=\"token function\">myproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> find_idx <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> t<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>t<span class=\"token operator\">&lt;</span><span class=\"token number\">64</span><span class=\"token punctuation\">;</span>t<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>addr <span class=\"token operator\">==</span> ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>p <span class=\"token operator\">==</span> p<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>is_used <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n        find_idx <span class=\"token operator\">=</span> t<span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>find_idx <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">//cprintf(\"error: unmap no such address!\\n\");</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  uint ptr <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token class-name\">pte_t</span><span class=\"token operator\">*</span> pte<span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>ptr <span class=\"token operator\">=</span> addr<span class=\"token punctuation\">;</span> ptr <span class=\"token operator\">&lt;</span> addr<span class=\"token operator\">+</span>ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> ptr <span class=\"token operator\">+=</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    pte <span class=\"token operator\">=</span> <span class=\"token function\">walkpgdir</span><span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>pte<span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// page fault has not been occurred on that address, just remove mmap_area structure.</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte <span class=\"token operator\">&amp;</span> PTE_P<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\r\n    uint paddr <span class=\"token operator\">=</span> <span class=\"token function\">PTE_ADDR</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>v <span class=\"token operator\">=</span> <span class=\"token function\">P2V</span><span class=\"token punctuation\">(</span>paddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">kfree</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token operator\">*</span>pte <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>f <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>addr <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>length <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>prot <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>flags <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>p <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  ma<span class=\"token punctuation\">[</span>find_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>is_used <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>구현시 참고한 함수</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span>\r\n<span class=\"token function\">deallocuvm</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">,</span> uint oldsz<span class=\"token punctuation\">,</span> uint newsz<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n  <span class=\"token class-name\">pte_t</span> <span class=\"token operator\">*</span>pte<span class=\"token punctuation\">;</span>\r\n  uint a<span class=\"token punctuation\">,</span> pa<span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>newsz <span class=\"token operator\">>=</span> oldsz<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">return</span> oldsz<span class=\"token punctuation\">;</span>\r\n\r\n  a <span class=\"token operator\">=</span> <span class=\"token function\">PGROUNDUP</span><span class=\"token punctuation\">(</span>newsz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> a  <span class=\"token operator\">&lt;</span> oldsz<span class=\"token punctuation\">;</span> a <span class=\"token operator\">+=</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    pte <span class=\"token operator\">=</span> <span class=\"token function\">walkpgdir</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>a<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>pte<span class=\"token punctuation\">)</span>\r\n      a <span class=\"token operator\">=</span> <span class=\"token function\">PGADDR</span><span class=\"token punctuation\">(</span><span class=\"token function\">PDX</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> PGSIZE<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte <span class=\"token operator\">&amp;</span> PTE_P<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      pa <span class=\"token operator\">=</span> <span class=\"token function\">PTE_ADDR</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>pa <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"kfree\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>v <span class=\"token operator\">=</span> <span class=\"token function\">P2V</span><span class=\"token punctuation\">(</span>pa<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token function\">kfree</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token operator\">*</span>pte <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">return</span> newsz<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>munmap() 구현은 deallocuvm()를 많이 참고하였다. 우선 <code class=\"language-text\">if (addr == ma[t].addr)</code> 을 만족하고 자신의 프로세스가 맞으며, <code class=\"language-text\">ma[t].is_used = 1</code> 인 mmap_area를 찾는다. 만약 이것이 없으면 return -1 를 수행한다. 이어서 free를 진행하는데, 우선 walkpgdir로 페이지 테이블을 순회하며 각 페이지가 있는지 확인한다. 만약 특정 페이지가 없으면, <code class=\"language-text\">if(!pte) continue;</code>를 통해 그냥 지나치고 마지막 mmap_area 초기화로 간다. 또한 <code class=\"language-text\">pte &amp; PTE_P</code> 도 확인한다. 만약 특정 페이지가 있으면, PTE_ADDR(pte)를 통해 주소를 얻고 P2V()를 통해 가상 주소로 바꾼다음 kfree()로 해제한다. pte의 경우 <code class=\"language-text\">*pte = 0;</code>로 해제한다. 최종적으로는 mmap_area의 값을 모두 0으로 초기화 해준다.</p>\n<h4 id=\"105-freemem-구현\" style=\"position:relative;\"><a href=\"#105-freemem-%EA%B5%AC%ED%98%84\" aria-label=\"105 freemem 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10.5. freemem() 구현</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token function\">freememCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>freemem()의 경우, kalloc()에서 직접 계산한 freememC값을 전달받아 반환하도록 하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">\r\nuint freememC<span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token keyword\">void</span>\r\n<span class=\"token function\">kfree</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>v<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">run</span> <span class=\"token operator\">*</span>r<span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">)</span>v <span class=\"token operator\">%</span> PGSIZE <span class=\"token operator\">||</span> v <span class=\"token operator\">&lt;</span> end <span class=\"token operator\">||</span> <span class=\"token function\">V2P</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> PHYSTOP<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"kfree\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token comment\">// Fill with junk to catch dangling refs.</span>\r\n  <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  freememC<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\r\n  \r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>kmem<span class=\"token punctuation\">.</span>use_lock<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>kmem<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  r <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">run</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v<span class=\"token punctuation\">;</span>\r\n  r<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> kmem<span class=\"token punctuation\">.</span>freelist<span class=\"token punctuation\">;</span>\r\n  kmem<span class=\"token punctuation\">.</span>freelist <span class=\"token operator\">=</span> r<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>kmem<span class=\"token punctuation\">.</span>use_lock<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>kmem<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">char</span><span class=\"token operator\">*</span>\r\n<span class=\"token function\">kalloc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">run</span> <span class=\"token operator\">*</span>r<span class=\"token punctuation\">;</span>\r\n  freememC<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>kmem<span class=\"token punctuation\">.</span>use_lock<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>kmem<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  r <span class=\"token operator\">=</span> kmem<span class=\"token punctuation\">.</span>freelist<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span>\r\n    kmem<span class=\"token punctuation\">.</span>freelist <span class=\"token operator\">=</span> r<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>kmem<span class=\"token punctuation\">.</span>use_lock<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>kmem<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>r<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">int</span> <span class=\"token function\">freememCount</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> freememC<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>kfree()가 호출될 시 <code class=\"language-text\">freememC++;</code>를 진행하고, kalloc()시 <code class=\"language-text\">freememC--;</code>를 진행했다.</p>\n<h4 id=\"106-fork-수정\" style=\"position:relative;\"><a href=\"#106-fork-%EC%88%98%EC%A0%95\" aria-label=\"106 fork 수정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10.6. fork 수정</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span>\r\n<span class=\"token function\">fork</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">proc</span> <span class=\"token operator\">*</span>np<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">proc</span> <span class=\"token operator\">*</span>curproc <span class=\"token operator\">=</span> <span class=\"token function\">myproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token comment\">// Allocate process.</span>\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>np <span class=\"token operator\">=</span> <span class=\"token function\">allocproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">// Copy process state from proc.</span>\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>np<span class=\"token operator\">-></span>pgdir <span class=\"token operator\">=</span> <span class=\"token function\">copyuvm</span><span class=\"token punctuation\">(</span>curproc<span class=\"token operator\">-></span>pgdir<span class=\"token punctuation\">,</span> curproc<span class=\"token operator\">-></span>sz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">kfree</span><span class=\"token punctuation\">(</span>np<span class=\"token operator\">-></span>kstack<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    np<span class=\"token operator\">-></span>kstack <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    np<span class=\"token operator\">-></span>state <span class=\"token operator\">=</span> UNUSED<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  np<span class=\"token operator\">-></span>vruntime <span class=\"token operator\">=</span> curproc<span class=\"token operator\">-></span>vruntime<span class=\"token punctuation\">;</span> <span class=\"token comment\">//==========================================</span>\r\n  np<span class=\"token operator\">-></span>sz <span class=\"token operator\">=</span> curproc<span class=\"token operator\">-></span>sz<span class=\"token punctuation\">;</span>\r\n  np<span class=\"token operator\">-></span>parent <span class=\"token operator\">=</span> curproc<span class=\"token punctuation\">;</span>\r\n  <span class=\"token operator\">*</span>np<span class=\"token operator\">-></span>tf <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>curproc<span class=\"token operator\">-></span>tf<span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token comment\">// Clear %eax so that fork returns 0 in the child.</span>\r\n  np<span class=\"token operator\">-></span>tf<span class=\"token operator\">-></span>eax <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> NOFILE<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>curproc<span class=\"token operator\">-></span>ofile<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\r\n      np<span class=\"token operator\">-></span>ofile<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">filedup</span><span class=\"token punctuation\">(</span>curproc<span class=\"token operator\">-></span>ofile<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  np<span class=\"token operator\">-></span>cwd <span class=\"token operator\">=</span> <span class=\"token function\">idup</span><span class=\"token punctuation\">(</span>curproc<span class=\"token operator\">-></span>cwd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token function\">safestrcpy</span><span class=\"token punctuation\">(</span>np<span class=\"token operator\">-></span>name<span class=\"token punctuation\">,</span> curproc<span class=\"token operator\">-></span>name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>curproc<span class=\"token operator\">-></span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token number\">64</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>is_used <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>p <span class=\"token operator\">==</span> curproc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> t <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>t<span class=\"token operator\">&lt;</span><span class=\"token number\">64</span><span class=\"token punctuation\">;</span>t<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>is_used <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n          ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>f <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>f<span class=\"token punctuation\">;</span>\r\n          ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>addr <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>addr<span class=\"token punctuation\">;</span>\r\n          ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>length <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\r\n          ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>offset <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>offset<span class=\"token punctuation\">;</span>\r\n          ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>prot <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>prot<span class=\"token punctuation\">;</span>\r\n          ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>flags <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>flags<span class=\"token punctuation\">;</span>\r\n          ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>p <span class=\"token operator\">=</span> np<span class=\"token punctuation\">;</span>\r\n          ma<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>is_used <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>is_used <span class=\"token punctuation\">;</span>\r\n\r\n          uint ptr <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n          uint addr <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>addr<span class=\"token punctuation\">;</span>\r\n          <span class=\"token class-name\">pte_t</span><span class=\"token operator\">*</span> pte<span class=\"token punctuation\">;</span>\r\n          <span class=\"token keyword\">int</span> prot_write <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n\r\n          <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> mem <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n          \r\n          <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>ptr <span class=\"token operator\">=</span> addr<span class=\"token punctuation\">;</span> ptr <span class=\"token operator\">&lt;</span> addr<span class=\"token operator\">+</span>ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> ptr <span class=\"token operator\">+=</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n            pte <span class=\"token operator\">=</span> <span class=\"token function\">walkpgdir</span><span class=\"token punctuation\">(</span>curproc<span class=\"token operator\">-></span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>pte<span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// not in pte pass</span>\r\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte <span class=\"token operator\">&amp;</span> PTE_P<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\r\n            mem <span class=\"token operator\">=</span> <span class=\"token function\">kalloc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mem<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n            <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            <span class=\"token function\">memmove</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>ptr<span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            <span class=\"token keyword\">int</span> perm <span class=\"token operator\">=</span> ma<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>prot <span class=\"token operator\">|</span> PTE_U<span class=\"token punctuation\">;</span>\r\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prot_write<span class=\"token punctuation\">)</span> perm <span class=\"token operator\">=</span> perm <span class=\"token operator\">|</span> PTE_W<span class=\"token punctuation\">;</span>\r\n            <span class=\"token keyword\">int</span> ret <span class=\"token operator\">=</span> <span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span>np<span class=\"token operator\">-></span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>ptr<span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">,</span> <span class=\"token function\">V2P</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> perm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n          <span class=\"token punctuation\">}</span>\r\n          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  pid <span class=\"token operator\">=</span> np<span class=\"token operator\">-></span>pid<span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>ptable<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  np<span class=\"token operator\">-></span>state <span class=\"token operator\">=</span> RUNNABLE<span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>ptable<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">return</span> pid<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>우선, 중첩 반복문 중 첫번째 for문에서 mmap_area 중 부모(curproc)와 관련된 모든 것들을 방문한다. 두번째 for문에서는 mmap_area중 비어있는 것을 하나 찾는다. 찾았을 때, 우선 비어있는 mmap_area에 자식을 할당하기 위해 부모의 mmap_area를 복제하되, <code class=\"language-text\">ma[t].p = np;</code> 만큼은 자식 프로세스(np)로 넣는다. 이후에는 부모와 동일하게 자식의 매핑을 진행한다. 여기서는 munmap과 비슷하게 walkpgdir()로 부모에 할당되어 있는 모든 페이지들을 확인하고, 만약 페이지가 존재할경우, kalloc();을 통해 새 물리 페이지를 할당하고 <code class=\"language-text\">memset(mem, 0, PGSIZE);</code>을 통해 초기화한 다음 <code class=\"language-text\">memmove(mem, (void*)ptr, PGSIZE);</code>로 부모의 것을 복제한다. 마지막으로는 mappages()를 진행한다. 일련의 과정이 끝나면 두번째 포문을 바로 break하고(부모것을 하나 완료했으므로) 다시 첫번째 포문으로 돌아가 다음 부모의 mmap_area을 찾아서 위의 과정을 반복한다.</p>\n<h4 id=\"11-테스트-코드\" style=\"position:relative;\"><a href=\"#11-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C\" aria-label=\"11 테스트 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>11. 테스트 코드</h4>\n<p>임시적으로 README는 1과 2로 이루어진 파일로 변경하였다.</p>\n<p>코드</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> <span class=\"token number\">4096</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">char</span><span class=\"token operator\">*</span> text <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> PROT_READ<span class=\"token punctuation\">,</span> MAP_POPULATE<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"mmap return is: %d\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>결과</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">mmap <span class=\"token keyword\">return</span> is<span class=\"token operator\">:</span> <span class=\"token number\">0</span></code></pre></div>\n<p>It’s not anonymous, but when the fd is -1 을 잘 처리한다.</p>\n<p>코드</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> <span class=\"token number\">4096</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"README\"</span><span class=\"token punctuation\">,</span> O_RDONLY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">char</span><span class=\"token operator\">*</span> text <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> PROT_READ<span class=\"token operator\">|</span>PROT_WRITE<span class=\"token punctuation\">,</span> MAP_POPULATE<span class=\"token punctuation\">,</span> fd<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"mmap return is: %d\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>결과</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">mmap <span class=\"token keyword\">return</span> is<span class=\"token operator\">:</span> <span class=\"token number\">0</span></code></pre></div>\n<p>The protection of the file and the prot of the parameter are different 을 잘 처리한다</p>\n<p>코드</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> <span class=\"token number\">8192</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"README\"</span><span class=\"token punctuation\">,</span> O_RDONLY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">char</span><span class=\"token operator\">*</span> text <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> PROT_READ<span class=\"token punctuation\">,</span> MAP_POPULATE<span class=\"token punctuation\">,</span> fd<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"mmap return is: %d\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text[0] is: %c\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>결과</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">mmap <span class=\"token keyword\">return</span> is<span class=\"token operator\">:</span> <span class=\"token number\">1073741824</span>\r\ntext<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> is<span class=\"token operator\">:</span> <span class=\"token number\">1</span></code></pre></div>\n<p>MAP_POPULATE 인 경우 파일을 잘 불러온다.</p>\n<p>코드</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> <span class=\"token number\">8192</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"README\"</span><span class=\"token punctuation\">,</span> O_RDONLY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">char</span><span class=\"token operator\">*</span> text <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> PROT_READ<span class=\"token punctuation\">,</span> MAP_ANONYMOUS<span class=\"token operator\">|</span>MAP_POPULATE<span class=\"token punctuation\">,</span> fd<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"mmap return is: %d\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text[0] is: %d\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>결과</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">mmap <span class=\"token keyword\">return</span> is<span class=\"token operator\">:</span> <span class=\"token number\">1073741824</span>\r\ntext<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> is<span class=\"token operator\">:</span> <span class=\"token number\">0</span></code></pre></div>\n<p>0으로 잘 초기화 된다.</p>\n<p>코드</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> <span class=\"token number\">8192</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"README\"</span><span class=\"token punctuation\">,</span> O_RDONLY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">char</span><span class=\"token operator\">*</span> text <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> PROT_READ<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> fd<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"mmap return is: %d\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text[4100] is: %c\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">[</span><span class=\"token number\">4100</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token comment\">// for(int i=4096; i&lt;size; i++) printf(1, \"%c\", *(text+i));</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text[300] is: %c\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">[</span><span class=\"token number\">300</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>결과</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">freemem now is <span class=\"token number\">56788</span>\r\nmmap <span class=\"token keyword\">return</span> is<span class=\"token operator\">:</span> <span class=\"token number\">1073741824</span>\r\nfreemem now is <span class=\"token number\">56788</span>\r\ntext<span class=\"token punctuation\">[</span><span class=\"token number\">4100</span><span class=\"token punctuation\">]</span> is<span class=\"token operator\">:</span> <span class=\"token number\">2</span>\r\nfreemem now is <span class=\"token number\">56786</span>\r\ntext<span class=\"token punctuation\">[</span><span class=\"token number\">300</span><span class=\"token punctuation\">]</span> is<span class=\"token operator\">:</span> <span class=\"token number\">1</span>\r\nfreemem now is <span class=\"token number\">56785</span></code></pre></div>\n<p>mmap 시에는 페이지가 늘어나지 않고, 4100을 접근하자 페이지 테이블용 1개, 파일 매핑용 1개 총 2개의 페이지가 늘어났다. 300 접근시 마지막 1개가 생기는 모습을 볼 수 있다.</p>\n<p>코드</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> <span class=\"token number\">8192</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"README\"</span><span class=\"token punctuation\">,</span> O_RDONLY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">char</span><span class=\"token operator\">*</span> text <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> PROT_READ<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> fd<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"mmap return is: %d\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text[9000] is: %c\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">[</span><span class=\"token number\">9000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>결과</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">mmap <span class=\"token keyword\">return</span> is<span class=\"token operator\">:</span> <span class=\"token number\">1073741824</span>\r\npid <span class=\"token number\">3</span> mytest<span class=\"token operator\">:</span> trap <span class=\"token number\">14</span> err <span class=\"token number\">4</span> on cpu <span class=\"token number\">0</span> eip <span class=\"token number\">0x45</span> addr <span class=\"token number\">0x40002328</span><span class=\"token operator\">--</span>kill proc</code></pre></div>\n<p>If faulted address has no corresponding mmap_area, return -1에 따라 프로세스가 잘 종료된다.</p>\n<p>코드</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> <span class=\"token number\">8192</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"README\"</span><span class=\"token punctuation\">,</span> O_RDONLY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">char</span><span class=\"token operator\">*</span> text <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> PROT_READ<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> fd<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"mmap return is: %d\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\ntext<span class=\"token punctuation\">[</span><span class=\"token number\">5000</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token char\">'5'</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>결과</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">mmap <span class=\"token keyword\">return</span> is<span class=\"token operator\">:</span> <span class=\"token number\">1073741824</span>\r\npid <span class=\"token number\">3</span> mytest<span class=\"token operator\">:</span> trap <span class=\"token number\">14</span> err <span class=\"token number\">6</span> on cpu <span class=\"token number\">0</span> eip <span class=\"token number\">0x45</span> addr <span class=\"token number\">0x40001388</span><span class=\"token operator\">--</span>kill proc</code></pre></div>\n<p>프로세스가 잘 종료된다.</p>\n<p>코드</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> <span class=\"token number\">8192</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"README\"</span><span class=\"token punctuation\">,</span> O_RDONLY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">char</span><span class=\"token operator\">*</span> text <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> PROT_READ<span class=\"token punctuation\">,</span> MAP_POPULATE<span class=\"token punctuation\">,</span> fd<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"mmap return is: %d\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span> ret <span class=\"token operator\">=</span> <span class=\"token function\">munmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">+</span> MMAPBASE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"munmap return is: %d\\n\"</span><span class=\"token punctuation\">,</span> ret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>결과</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">freemem now is <span class=\"token number\">56788</span>\r\nmmap <span class=\"token keyword\">return</span> is<span class=\"token operator\">:</span> <span class=\"token number\">1073741824</span>\r\nfreemem now is <span class=\"token number\">56785</span>\r\nmunmap <span class=\"token keyword\">return</span> is<span class=\"token operator\">:</span> <span class=\"token number\">1</span>\r\nfreemem now is <span class=\"token number\">56787</span></code></pre></div>\n<p>첫 할당시 테이블을 포함한 3개의 페이지가 줄어들며, 언맵이 성공적으로 진행된 후에는 테이블을 제외한 2개의 페이지가 다시 돌아오는 걸 볼 수 있다.</p>\n<p>코드</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> <span class=\"token number\">8192</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"README\"</span><span class=\"token punctuation\">,</span> O_RDONLY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">char</span><span class=\"token operator\">*</span> text <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> PROT_READ<span class=\"token punctuation\">,</span> MAP_POPULATE<span class=\"token punctuation\">,</span> fd<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"mmap return is: %d\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span> ret <span class=\"token operator\">=</span> <span class=\"token function\">munmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">+</span> MMAPBASE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"munmap return is: %d\\n\"</span><span class=\"token punctuation\">,</span> ret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>결과</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">freemem now is <span class=\"token number\">56788</span>\r\nmmap <span class=\"token keyword\">return</span> is<span class=\"token operator\">:</span> <span class=\"token number\">1073750016</span>\r\nfreemem now is <span class=\"token number\">56785</span>\r\nmunmap <span class=\"token keyword\">return</span> is<span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span>\r\nfreemem now is <span class=\"token number\">56785</span></code></pre></div>\n<p>없는 주소를 munmap하자 -1을 잘 리턴하고 freemem도 변하지 않았다.</p>\n<p>코드</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> <span class=\"token number\">8192</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"README\"</span><span class=\"token punctuation\">,</span> O_RDWR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">char</span><span class=\"token operator\">*</span> text <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> PROT_READ<span class=\"token operator\">|</span>PROT_WRITE<span class=\"token punctuation\">,</span> MAP_POPULATE<span class=\"token punctuation\">,</span> fd<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"mmap return is: %d\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"parent text[110] is: %c\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\ntext<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token char\">'9'</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"parent text[110] is: %c\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token keyword\">int</span> fo<span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>fo<span class=\"token operator\">=</span><span class=\"token function\">fork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">==</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"fork! child freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"child text[110] is: %c\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  text<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token char\">'7'</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"child text[110] is: %c\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n<span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"parent freemem now is %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">freemem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"parent text[110] is: %c\\n\"</span><span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>결과</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">freemem now is <span class=\"token number\">56788</span>\r\nmmap <span class=\"token keyword\">return</span> is<span class=\"token operator\">:</span> <span class=\"token number\">1073741824</span>\r\nfreemem now is <span class=\"token number\">56785</span>\r\nparent text<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span> is<span class=\"token operator\">:</span> <span class=\"token number\">1</span>\r\nparent text<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span> is<span class=\"token operator\">:</span> <span class=\"token number\">9</span>\r\nfork<span class=\"token operator\">!</span> child freemem now is <span class=\"token number\">56712</span>\r\nchild text<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span> is<span class=\"token operator\">:</span> <span class=\"token number\">9</span>\r\nchild text<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span> is<span class=\"token operator\">:</span> <span class=\"token number\">7</span>\r\nparent freemem now is <span class=\"token number\">56785</span>\r\nparent text<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span> is<span class=\"token operator\">:</span> <span class=\"token number\">9</span></code></pre></div>\n<p>fork시 부모의 mmap_area와 물리 메모리 매핑을 잘 복제하는 모습을 보여준다.</p>\n<h2 id=\"source\" style=\"position:relative;\"><a href=\"#source\" aria-label=\"source permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Source</h2>\n<ul>\n<li>mit-pdos/xv6-public<br>\n<a href=\"https://github.com/mit-pdos/xv6-public\" target=\"_blank\" rel=\"nofollow\">https://github.com/mit-pdos/xv6-public</a></li>\n</ul>","id":"b2662c7c-7dce-56cf-8a45-ac4c8fd75bf5","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EB%AA%A9%ED%91%9C\">목표</a></p>\n<ul>\n<li><a href=\"#virtual-memory%EC%97%90-%ED%95%B4%EB%8B%B9%ED%95%98%EB%8A%94-mmap-%ED%95%A8%EC%88%98-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\">Virtual memory에 해당하는 mmap() 함수 구현하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B3%BC%EC%A0%95\">과정</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"#0-usyss-%EC%97%90-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EC%BD%9C-%EC%B6%94%EA%B0%80\">0. usys.S 에 시스템 콜 추가</a></li>\n<li><a href=\"#1userh%EC%97%90-%ED%95%A8%EC%88%98-%EC%B6%94%EA%B0%80\">1.user.h에 함수 추가</a></li>\n<li><a href=\"#2syscallh-%EC%97%90-%EC%BD%94%EB%93%9C-%EC%B6%94%EA%B0%80\">2.syscall.h 에 코드 추가</a></li>\n<li><a href=\"#3syscallc%EC%97%90-%EC%BD%94%EB%93%9C-%EC%B6%94%EA%B0%80\">3.syscall.c에 코드 추가</a></li>\n<li><a href=\"#4-sysprocc%EC%97%90-%ED%95%A8%EC%88%98-%EC%B6%94%EA%B0%80\">4. sysproc.c에 함수 추가</a></li>\n<li><a href=\"#5-paramh%EC%97%90-%EC%BD%94%EB%93%9C-%EC%B6%94%EA%B0%80\">5. param.h에 코드 추가</a></li>\n<li><a href=\"#6-vmc-%EB%B3%80%EA%B2%BD\">6. vm.c 변경</a></li>\n<li><a href=\"#7-defsh-%EC%B6%94%EA%B0%80\">7. defs.h 추가</a></li>\n<li><a href=\"#8-typesh-%EC%88%98%EC%A0%95\">8. types.h 수정</a></li>\n<li><a href=\"#9-proch\">9. proc.h</a></li>\n<li><a href=\"#10-procc\">10. proc.c</a></li>\n<li><a href=\"#101-%EC%B4%88%EA%B8%B0-%EC%84%A0%EC%96%B8\">10.1. 초기 선언</a></li>\n<li><a href=\"#102-mmap-%ED%95%A8%EC%88%98-%EC%B6%94%EA%B0%80\">10.2. mmap 함수 추가</a></li>\n<li><a href=\"#103-page-fault-handler-%EA%B5%AC%ED%98%84\">10.3. Page Fault Handler 구현</a></li>\n<li><a href=\"#1031-trapc\">10.3.1 trap.c</a></li>\n<li><a href=\"#1032-pfhpage-fault-handler%ED%95%A8%EC%88%98-%EA%B5%AC%ED%98%84\">10.3.2 pfh(Page Fault Handler)함수 구현</a></li>\n<li><a href=\"#104-munmap-%EA%B5%AC%ED%98%84\">10.4. munmap() 구현</a></li>\n<li><a href=\"#105-freemem-%EA%B5%AC%ED%98%84\">10.5. freemem() 구현</a></li>\n<li><a href=\"#106-fork-%EC%88%98%EC%A0%95\">10.6. fork 수정</a></li>\n<li><a href=\"#11-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C\">11. 테스트 코드</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#source\">Source</a></p>\n</li>\n</ul>","frontmatter":{"title":"XV6 운영체제 개선해 보기 <Virtual memory, mmap() 구현하기>","summary":"XV6 운영체제의 구성을 알아보고 추가적인 기능을 도전해봅니다.","date":"2023.09.05.","categories":["Operating System"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA80lEQVQoz92SS0tCURSF/ZOBYN3buRmIgyKIIEgIx5LpfSgUFV2EizoTH/SUwMfAB1hOlPCnfLL1DLsozQrWYC043z777H0i7j6/VuR/wI4pEmPo6JrYe6INsGNSjFOwxN8m8RSeJfH+mIcTqRIOK/K7+GeM6rQfGTd4KtJyxExeqKZXvajwmz2Lqx2m78x6+Kd8vtItM6wz70uVm4R+UQisuI4ybbMYSfweMqjx4dOrMG5Sy5CNypkfYE+RixFc0K+KgpQAnYDKJV9vTJ4pnZOPhcB6YIfSvKv05AoH2AZ3RzI/29hiVdqvlrSOW63q73zPJU+/WoDmnxbZAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/0fe9f60f12a06de4130cb2f66fce12f1/55486/xv6.png","srcSet":"/static/0fe9f60f12a06de4130cb2f66fce12f1/ea722/xv6.png 200w,\n/static/0fe9f60f12a06de4130cb2f66fce12f1/f9bbb/xv6.png 400w,\n/static/0fe9f60f12a06de4130cb2f66fce12f1/55486/xv6.png 800w","sizes":"(min-width: 800px) 800px, 100vw"},"sources":[{"srcSet":"/static/0fe9f60f12a06de4130cb2f66fce12f1/4c856/xv6.webp 200w,\n/static/0fe9f60f12a06de4130cb2f66fce12f1/4dac1/xv6.webp 400w,\n/static/0fe9f60f12a06de4130cb2f66fce12f1/d0f18/xv6.webp 800w","type":"image/webp","sizes":"(min-width: 800px) 800px, 100vw"}]},"width":800,"height":600}},"publicURL":"/static/0fe9f60f12a06de4130cb2f66fce12f1/xv6.png"}}}}]}},"pageContext":{"slug":"/xv6_3/"}},"staticQueryHashes":[]}