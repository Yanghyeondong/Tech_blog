{"componentChunkName":"component---src-templates-post-template-tsx","path":"/dockerfile-nvm-error/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h2 id=\"1-미리-보는-결론-\" style=\"position:relative;\"><a href=\"#1-%EB%AF%B8%EB%A6%AC-%EB%B3%B4%EB%8A%94-%EA%B2%B0%EB%A1%A0-\" aria-label=\"1 미리 보는 결론  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 미리 보는 결론 👀</h2>\n<p>다음과 같이 dockerfile을 구성하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ubuntu:22.04</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">Run</span> apt update -y &amp;&amp; <span class=\"token operator\">\\</span>\r\n    apt upgrade -y &amp;&amp; <span class=\"token operator\">\\</span>\r\n    apt install -y <span class=\"token operator\">\\</span>\r\n    curl</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">SHELL</span> [<span class=\"token string\">\"/bin/bash\"</span>, <span class=\"token string\">\"-c\"</span>]</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> source ~/.nvm/nvm.sh &amp;&amp; nvm install 16.16.0 &amp;&amp; npm install -g yarn</span></code></pre></div>\n<h2 id=\"2-문제-인식\" style=\"position:relative;\"><a href=\"#2-%EB%AC%B8%EC%A0%9C-%EC%9D%B8%EC%8B%9D\" aria-label=\"2 문제 인식 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 문제 인식</h2>\n<p>기술 블로그로 사용하고 있는 현 Gatsby 블로그를 기존 windows 환경에서 docker로 이전하려고 했습니다.\r\n운영체제를 포맷하거나 바꿔도 블로그는 여전히 작성해야하고, 그때마다 환경을 바꾸면 힘들기 때문이죠. <del>미리하는 개고생 😭</del></p>\n<h2 id=\"3-설명\" style=\"position:relative;\"><a href=\"#3-%EC%84%A4%EB%AA%85\" aria-label=\"3 설명 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 설명</h2>\n<p>우선, <code class=\"language-text\">dockerfile</code>을 작성하기 전에 직접 <code class=\"language-text\">ubuntu:22.04</code> 컨테이너를 기반으로 하나씩 패키지를 설치하며 테스트를 마쳤습니다.<br>\n그리고, 위에서 사용했던 명령어를 바탕으로 다음같이 첫번째 <code class=\"language-text\">dockerfile</code>을 만들었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\">//version 1\r\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ubuntu:22.04</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">Run</span> apt update -y &amp;&amp; <span class=\"token operator\">\\</span>\r\n    apt upgrade -y &amp;&amp; <span class=\"token operator\">\\</span>\r\n    apt install -y <span class=\"token operator\">\\</span>\r\n    curl</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash &amp;&amp; <span class=\"token operator\">\\</span>\r\n\tsource ~/.bashrc</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> nvm install 16.16.0 &amp;&amp; <span class=\"token operator\">\\</span>\r\n\tnpm install -g yarn</span></code></pre></div>\n<p>하지만 돌아온 것은 다음같은 에러.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">(생략)\r\n1.140 /bin/sh: 1: source: not found\r\n------\r\ndockerfile:8\r\n--------------------\r\n   7 |     \r\n   8 | >>> RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash &amp;&amp; \\\r\n   9 | >>>      source ~/.bashrc\r\n  10 |     \r\n--------------------\r\nERROR: failed to solve: process \"/bin/sh -c curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash &amp;&amp; \\tsource ~/.bashrc\" did not complete successfully: exit code: 127</code></pre></div>\n<p>에러의 요지는 다음과 같습니다. <code class=\"language-text\">/bin/sh: 1: source: not found</code>, <code class=\"language-text\">source</code> 라는 명령어를 못찾겠다. 분명 실제 <code class=\"language-text\">ubuntu:22.04</code> 컨테이너에서 사용했을때는 문제가 없었는데 왜일까요?<br>\n<br>\n답은 stackoverflow에서 찾았습니다. <a href=\"https://stackoverflow.com/questions/20635472/using-the-run-instruction-in-a-dockerfile-with-source-does-not-work\" target=\"_blank\" rel=\"nofollow\">Using the RUN instruction in a Dockerfile with ‘source’ does not work</a>. 답변을 정리하면, <code class=\"language-text\">bash(Bourne Again Shell)</code>와 <code class=\"language-text\">sh(Bourne shell)</code>, 정확히는 ubuntu의 <code class=\"language-text\">dash</code>의 차이 때문입니다.\r\n<code class=\"language-text\">bash</code>에는 <code class=\"language-text\">source</code>가 있고, <code class=\"language-text\">dash</code>에는 <code class=\"language-text\">source</code>가 없기 때문에 문제가 생깁니다.<br>\n<br>\n평소 사용하던 ubuntu login shell은 <code class=\"language-text\">bash</code> 입니다. ps를 치면 다음과 같이 나오죠.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">root@ff529b1771e7:~# ps\r\n  PID TTY          TIME CMD\r\n10714 pts/1    00:00:00 bash\r\n10905 pts/1    00:00:00 ps</code></pre></div>\n<p>하지만 ubuntu system shell 에서 사용하는 것은 <code class=\"language-text\">dash</code>입니다. 즉, <code class=\"language-text\">dockerfile</code> 에서는 <code class=\"language-text\">dash</code>가 사용되기에 <code class=\"language-text\">source ~/.bashrc</code> 에서 오류가 발생합니다.<br>\n<br>\n해결책은 간단합니다. <code class=\"language-text\">SHELL [\"/bin/bash\", \"-c\"]</code>을 넣어서 실행하는 셸을 <code class=\"language-text\">bash</code>로 바꿉니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\">//version 2\r\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ubuntu:22.04</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">Run</span> apt update -y &amp;&amp; <span class=\"token operator\">\\</span>\r\n    apt upgrade -y &amp;&amp; <span class=\"token operator\">\\</span>\r\n    apt install -y <span class=\"token operator\">\\</span>\r\n    curl</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">SHELL</span> [<span class=\"token string\">\"/bin/bash\"</span>, <span class=\"token string\">\"-c\"</span>]</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> source ~/.bashrc</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> nvm install 16.16.0 &amp;&amp; <span class=\"token operator\">\\</span>\r\n\tnpm install -g yarn</span></code></pre></div>\n<p>근데 또 다른 에러가 발생합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0.493 /bin/bash: line 1: nvm: command not found\r\n------\r\ndockerfile:14\r\n--------------------\r\n  13 |\r\n  14 | >>> RUN nvm install 16.16.0 &amp;&amp; \\\r\n  15 | >>>      npm install -g yarn\r\n--------------------\r\nERROR: failed to solve: process \"/bin/bash -c nvm install 16.16.0 &amp;&amp; \\tnpm install -g yarn\" did not complete successfully: exit code: 127</code></pre></div>\n<p>에러의 요지는 다음과 같습니다. <code class=\"language-text\">nvm: command not found</code>, <code class=\"language-text\">nvm</code>이라는 명령어를 못찾겠다.<br>\n이번에는 원인이 어느정도 바로 보입니다. 환경변수 등록 및 <code class=\"language-text\">source ~/.bashrc</code> 에 문제가 있었던거겠죠. 하지만, 왜 로그인 셸에서는 잘 작동한 <code class=\"language-text\">source ~/.bashrc</code>가 작동하지 않는지는 의문입니다.<br>\n인터넷을 좀 뒤져가며 테스트해보니 <code class=\"language-text\">source ~/.nvm/nvm.sh</code>가 잘 작동합니다. 저도 <code class=\"language-text\">nvm</code>의 구조는 잘 모르는 지라 추후 왜 이런지 확인은 필요할듯 싶습니다.<br>\n이렇게 변경한 <code class=\"language-text\">dockerfile</code>은 다음과 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\">//version 3\r\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ubuntu:22.04</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">Run</span> apt update -y &amp;&amp; <span class=\"token operator\">\\</span>\r\n    apt upgrade -y &amp;&amp; <span class=\"token operator\">\\</span>\r\n    apt install -y <span class=\"token operator\">\\</span>\r\n    curl</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">SHELL</span> [<span class=\"token string\">\"/bin/bash\"</span>, <span class=\"token string\">\"-c\"</span>]</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> source ~/.nvm/nvm.sh</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> nvm install 16.16.0 &amp;&amp; <span class=\"token operator\">\\</span>\r\n\tnpm install -g yarn</span></code></pre></div>\n<p>하지만 여전히 오류가 납니다…</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0.401 /bin/bash: line 1: nvm: command not found</code></pre></div>\n<p>한참을 찾은결과, 답은 여기에 있었습니다. <a href=\"https://github.com/nvm-sh/nvm/issues/920\" target=\"_blank\" rel=\"nofollow\">activating nvm during docker build</a>.\r\n사이트에서 스크롤을 내리다 보면 다음과 같은 표현이 있습니다.</p>\n<blockquote>\n<p>It turned out to be a docker peculiarity (or my misunderstand of it). Apparently the RUN commands don’t carry over from line to line and you can’t activate nvm in one line and then use it in the next. Chaining the calls in one RUN with &#x26;&#x26; solves the problem so not an nvm issue at all.</p>\n</blockquote>\n<p>즉, docker에서 <code class=\"language-text\">RUN</code>은 라인별로 새롭게 작동하기 때문에 기껏 <code class=\"language-text\">source ~/.nvm/nvm.sh</code>를 해도 전달이 안된 것 같습니다. 따라서 <code class=\"language-text\">&amp;&amp;</code>로 명령어를 이어줍니다.<br>\n이를 바탕으로 최종 dockerfile을 만들면 다음과 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\">//version 4\r\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ubuntu:22.04</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">Run</span> apt update -y &amp;&amp; <span class=\"token operator\">\\</span>\r\n    apt upgrade -y &amp;&amp; <span class=\"token operator\">\\</span>\r\n    apt install -y <span class=\"token operator\">\\</span>\r\n    curl</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash</span>\r\n\r\n<span class=\"token instruction\"><span class=\"token keyword\">SHELL</span> [<span class=\"token string\">\"/bin/bash\"</span>, <span class=\"token string\">\"-c\"</span>]</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> source ~/.nvm/nvm.sh &amp;&amp; nvm install 16.16.0 &amp;&amp; npm install -g yarn</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[+] Building 8.3s (8/8) FINISHED                                                  docker:default \r\n => [internal] load .dockerignore                                                           0.0s \r\n => => transferring context: 2B                                                             0.0s \r\n => [internal] load build definition from dockerfile                                        0.0s \r\n => => transferring dockerfile: 317B                                                        0.0s \r\n => [internal] load metadata for docker.io/library/ubuntu:22.04                             0.0s \r\n => [1/4] FROM docker.io/library/ubuntu:22.04                                               0.0s \r\n => CACHED [2/4] RUN apt update -y &amp;&amp;     apt upgrade -y &amp;&amp;     apt install -y     curl     0.0s \r\n => CACHED [3/4] RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install  0.0s \r\n => [4/4] RUN source ~/.nvm/nvm.sh &amp;&amp; nvm install 16.16.0 &amp;&amp; npm install -g yarn            7.8s \r\n => exporting to image                                                                      0.5s \r\n => => exporting layers                                                                     0.5s \r\n => => writing image sha256:79e8a3152b155fcc4b231180a19f5de15c7f29f86592a973f4a939ef5d627e  0.0s\r\n => => naming to docker.io/library/posttest</code></pre></div>\n<p>드디어 작동하네요 😎</p>\n<h2 id=\"source\" style=\"position:relative;\"><a href=\"#source\" aria-label=\"source permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Source</h2>\n<ul>\n<li>\n<p>Using the RUN instruction in a Dockerfile with ‘source’ does not work\r\n<a href=\"https://stackoverflow.com/questions/20635472/using-the-run-instruction-in-a-dockerfile-with-source-does-not-work\" target=\"_blank\" rel=\"nofollow\">https://stackoverflow.com/questions/20635472/using-the-run-instruction-in-a-dockerfile-with-source-does-not-work</a></p>\n</li>\n<li>\n<p>activating nvm during docker build\r\n<a href=\"https://github.com/nvm-sh/nvm/issues/920\" target=\"_blank\" rel=\"nofollow\">https://github.com/nvm-sh/nvm/issues/920</a></p>\n</li>\n</ul>","id":"5b3d1255-93a1-5a19-84fe-9a6fcde237dc","tableOfContents":"<ul>\n<li><a href=\"#1-%EB%AF%B8%EB%A6%AC-%EB%B3%B4%EB%8A%94-%EA%B2%B0%EB%A1%A0-\">1. 미리 보는 결론 👀</a></li>\n<li><a href=\"#2-%EB%AC%B8%EC%A0%9C-%EC%9D%B8%EC%8B%9D\">2. 문제 인식</a></li>\n<li><a href=\"#3-%EC%84%A4%EB%AA%85\">3. 설명</a></li>\n<li><a href=\"#source\">Source</a></li>\n</ul>","frontmatter":{"title":"dockerfile nvm 설치 에러 해결법 source: not found, nvm: command not found","summary":"dockerfile에 nvm을 설치하다 겪는 다양한 오류를 해결합니다. ","date":"2023.10.04.","categories":["Docker","DevOps","Back-end","Choice"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACd0lEQVQozzXQS08TURQH8DG95965M6UoxkQD8rKABSoPaelDTdRGG2wrlNJS2mlnpp1pS5FCsO1MS3lEBDU08kgEQ0zcuHKhKz+B7tzwBYwfwx2mGJOz+G9+5/xzGBdZdOKcAzIOyIxDxg6qHdQxUEZBGQFlGNKDIA+AbEFSLxLNKNmFEh1IaEPxayjGuMiyCy84cPa/V8dBtYE6hjOjoNxC0hBu+H6Q+5DUg8RulOxEwnUUb0Vxxs0W//nG/UaFxhY7ZEcM4hjOuXl9EIkDSBqAlAVJfUgyn/sOlGhDAnOH093scxcpuHDegefHz8dmyHhb9qWe79Otn2142cFrA5Dux0ofpHpBvgFyJ4jtKMm4uZqLak52xYkXnTjvJHkbUnxXjgpDv5Zu/85ZT1Xrz4j5mxWpFqzcBKUXUmaQu0BqB5Hx8ltebvMxrT4kxfuk4GGXHhiyie6vr+Wz7fif7eBZ3nZ6Dy/fbfx1wY7n7ZB3wKIdPxvGOSbWdBDl62FuZ4ZuBkklQEpPyMoElOf9XwqeH5HLn7xQ8pIVDyl6SPERKU8QzU+0ANF8pMRkmo8V06FkrM9xOyG6GWRXJ4nuY0tJ557s2Mt5jlPWvRlcnaK6j+h+UvGTRvCRcgNnm09U0zu1aV817or8yxBdm2Qrs7SW7a6rXfW0ZT9xdWcOV+NcLUqrIbb6lNUDrBZgNT8pM+lLH8Tm93HToWB8K/NvZH5L4NYTdD1sqE4bKsELlTBUo7QWo6tzdDVKqxFaCVN9mtUmSZnJtnxMXzyRTEdi04Fs3FWMr1T+hcRtCNxGjNsQ+PUkt5akNYHW4ud4llYiVA9RfYrV/gKyLLAQvHj5+QAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/24a1829822c3238c2b2095c75211000a/6b5dd/docker.png","srcSet":"/static/24a1829822c3238c2b2095c75211000a/6e8a2/docker.png 828w,\n/static/24a1829822c3238c2b2095c75211000a/cea6d/docker.png 1657w,\n/static/24a1829822c3238c2b2095c75211000a/6b5dd/docker.png 3313w","sizes":"(min-width: 3313px) 3313px, 100vw"},"sources":[{"srcSet":"/static/24a1829822c3238c2b2095c75211000a/59542/docker.webp 828w,\n/static/24a1829822c3238c2b2095c75211000a/d9ac6/docker.webp 1657w,\n/static/24a1829822c3238c2b2095c75211000a/11d54/docker.webp 3313w","type":"image/webp","sizes":"(min-width: 3313px) 3313px, 100vw"}]},"width":3313,"height":1864}},"publicURL":"/static/24a1829822c3238c2b2095c75211000a/docker.png"}}}}]}},"pageContext":{"slug":"/dockerfile-nvm-error/"}},"staticQueryHashes":[]}