{"componentChunkName":"component---src-templates-post-template-tsx","path":"/xv6_4/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p><em>해당 포스트는 MIT의 교육용 운영체제 XV6를 활용하며, 코드 저작권은 MIT에 있음을 밝힙니다.</em></p>\n<h2 id=\"목표\" style=\"position:relative;\"><a href=\"#%EB%AA%A9%ED%91%9C\" aria-label=\"목표 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>목표</h2>\n<h3 id=\"fs-swapin-swapout-구현하기\" style=\"position:relative;\"><a href=\"#fs-swapin-swapout-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\" aria-label=\"fs swapin swapout 구현하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FS swapin, swapout 구현하기</h3>\n<h2 id=\"과정\" style=\"position:relative;\"><a href=\"#%EA%B3%BC%EC%A0%95\" aria-label=\"과정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>과정</h2>\n<h4 id=\"0-typesh-수정\" style=\"position:relative;\"><a href=\"#0-typesh-%EC%88%98%EC%A0%95\" aria-label=\"0 typesh 수정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>0. types.h 수정</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>생략<span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">typedef</span> uint <span class=\"token class-name\">pte_t</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>kalloc()의 새로운 함수들에서 사용하게 되는 walkpgdir() 등을 위해 pte_t 자료형을 추가해준다.</p>\n<h4 id=\"1-defsh-수정\" style=\"position:relative;\"><a href=\"#1-defsh-%EC%88%98%EC%A0%95\" aria-label=\"1 defsh 수정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. defs.h 수정</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>생략<span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">void</span>            <span class=\"token function\">manage_pages</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">pde_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token class-name\">pte_t</span> <span class=\"token operator\">*</span>         <span class=\"token function\">walkpgdir</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>va<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> alloc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>vm.c 에서 kalloc.c에 있는 새로운 함수 manage_pages()와 기존의 walkpgdir를 호출할 수 있도록 만들어준다.</p>\n<h4 id=\"2-mmuh-수정\" style=\"position:relative;\"><a href=\"#2-mmuh-%EC%88%98%EC%A0%95\" aria-label=\"2 mmuh 수정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. mmu.h 수정</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>생략<span class=\"token punctuation\">)</span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PTE_A</span>           <span class=\"token expression\"><span class=\"token number\">0x020</span></span></span></code></pre></div>\n<p>PTE_A를 추가해주었다.</p>\n<h4 id=\"3-vmc-수정\" style=\"position:relative;\"><a href=\"#3-vmc-%EC%88%98%EC%A0%95\" aria-label=\"3 vmc 수정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. vm.c 수정</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token class-name\">pte_t</span> <span class=\"token operator\">*</span>\r\n<span class=\"token function\">walkpgdir</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>va<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> alloc<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span></code></pre></div>\n<p>기존의 static을 없애서 다른 곳에서도 쓸 수 있도록 하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span>\r\n<span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>va<span class=\"token punctuation\">,</span> uint size<span class=\"token punctuation\">,</span> uint pa<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> perm<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>생략<span class=\"token punctuation\">)</span>\r\n\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte <span class=\"token operator\">&amp;</span> PTE_U<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">manage_pages</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> pgdir<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>생략<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>기존의 mappages를 할때 그 사이에 page를 관리하는 직접 만든 함수 manage_pages()를 추가하였다. 여기서 첫번째 인자 1은 더하기 동작을 지시하는 인자이다. 나머지 두 인자는 pgdir와 가상주소를 전달한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span>\r\n<span class=\"token function\">deallocuvm</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">,</span> uint oldsz<span class=\"token punctuation\">,</span> uint newsz<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>생략<span class=\"token punctuation\">)</span>      \r\n<span class=\"token function\">manage_pages</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> pgdir<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>생략<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> newsz<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>deallocuvm()에서 메모리를 해제할때 manage_pages()함수를 추가하였다. 첫번째 인자 0은 제거하는 동작을 지시하는 인자이다. 나머지 두 인자는 pgdir와 가상주소를 전달한다.</p>\n<h4 id=\"4-kallocc-수정\" style=\"position:relative;\"><a href=\"#4-kallocc-%EC%88%98%EC%A0%95\" aria-label=\"4 kallocc 수정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. kalloc.c 수정</h4>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">char</span><span class=\"token operator\">*</span>\r\n<span class=\"token function\">kalloc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">run</span> <span class=\"token operator\">*</span>r<span class=\"token punctuation\">;</span>\r\n\r\ntry_again<span class=\"token operator\">:</span>\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>kmem<span class=\"token punctuation\">.</span>use_lock<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>kmem<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  r <span class=\"token operator\">=</span> kmem<span class=\"token punctuation\">.</span>freelist<span class=\"token punctuation\">;</span>\r\n  \r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>r<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>kmem<span class=\"token punctuation\">.</span>use_lock<span class=\"token punctuation\">)</span> <span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>kmem<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">reclaim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">goto</span> try_again<span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">cprintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error: OOM!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>kmem<span class=\"token punctuation\">.</span>use_lock<span class=\"token punctuation\">)</span> <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>kmem<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span>\r\n    kmem<span class=\"token punctuation\">.</span>freelist <span class=\"token operator\">=</span> r<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>kmem<span class=\"token punctuation\">.</span>use_lock<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>kmem<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>r<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>우선 기존의 코드에서는 <code class=\"language-text\">r = kmem.freelist</code> 가 발생했을시 오류가 생겼지만. 이 경우에는 우선 reclaim()을 시도해본다. 여기서 성공으로인해 1이 리턴될 경우 tryagain으로 돌아가서 해제된 메모리를 다시 받을 수 있도록 한다. 만약 0이 리턴될 경우 실패(더이상 LRU에 공간이 없음)로, <code class=\"language-text\">error: OOM!</code> 메세지를 호출한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">find_free_page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>PHYSTOP<span class=\"token operator\">/</span>PGSIZE<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>pages<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>vaddr <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> pages<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>pgdir <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">==</span>PHYSTOP<span class=\"token operator\">/</span>PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">return</span> i<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 함수는 현재 pages 중에서 비어있는 page를 찾아 인덱스를 리턴한다. 없을경우, -1을 리턴한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">find_page</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span><span class=\"token operator\">*</span> pgdir<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> va<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>PHYSTOP<span class=\"token operator\">/</span>PGSIZE<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>pages<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>pgdir <span class=\"token operator\">==</span> pgdir <span class=\"token operator\">&amp;&amp;</span> pages<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>vaddr <span class=\"token operator\">==</span> va<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">==</span>PHYSTOP<span class=\"token operator\">/</span>PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">return</span> i<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 함수는 현재 pages 중에서 인자로 전달된 pgdir과 va를 가지는 페이지의 인덱스를 리턴한다. 없을경우, -1을 리턴한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">manage_pages</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> ope<span class=\"token punctuation\">,</span> <span class=\"token class-name\">pde_t</span><span class=\"token operator\">*</span> pgdir<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> va<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ope <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span> <span class=\"token comment\">// add ------------------------------------------</span>\r\n\r\n    <span class=\"token keyword\">int</span> idx <span class=\"token operator\">=</span> <span class=\"token function\">find_free_page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>idx <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">page</span><span class=\"token operator\">*</span> tmp <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>pages<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\r\n    \r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>num_lru_pages <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token comment\">// first add</span>\r\n      page_lru_head <span class=\"token operator\">=</span> tmp<span class=\"token punctuation\">;</span>\r\n      tmp<span class=\"token operator\">-></span>vaddr <span class=\"token operator\">=</span> va<span class=\"token punctuation\">;</span>\r\n      tmp<span class=\"token operator\">-></span>pgdir <span class=\"token operator\">=</span> pgdir<span class=\"token punctuation\">;</span>\r\n      tmp<span class=\"token operator\">-></span>prev <span class=\"token operator\">=</span> page_lru_head<span class=\"token punctuation\">;</span>\r\n      tmp<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> page_lru_head<span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">//print_lru();</span>\r\n      tmp<span class=\"token operator\">-></span>vaddr <span class=\"token operator\">=</span> va<span class=\"token punctuation\">;</span>\r\n      tmp<span class=\"token operator\">-></span>pgdir <span class=\"token operator\">=</span> pgdir<span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token keyword\">struct</span> <span class=\"token class-name\">page</span><span class=\"token operator\">*</span> cur <span class=\"token operator\">=</span> page_lru_head<span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>cur<span class=\"token operator\">-></span>next <span class=\"token operator\">!=</span> page_lru_head<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n        cur <span class=\"token operator\">=</span> cur<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n\r\n      tmp<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> page_lru_head<span class=\"token punctuation\">;</span>\r\n      page_lru_head<span class=\"token operator\">-></span>prev <span class=\"token operator\">=</span> tmp<span class=\"token punctuation\">;</span>\r\n\r\n      tmp<span class=\"token operator\">-></span>prev <span class=\"token operator\">=</span> cur<span class=\"token punctuation\">;</span>\r\n      cur<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> tmp<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token punctuation\">}</span>\r\n    num_lru_pages<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\r\n    num_free_pages<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ope <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span> <span class=\"token comment\">// remove --------------------------------------------------</span>\r\n    <span class=\"token comment\">//cprintf(\"remove %x %x\\n\", pgdir, va);</span>\r\n    <span class=\"token keyword\">int</span> idx <span class=\"token operator\">=</span> <span class=\"token function\">find_page</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">,</span> va<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>idx <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">page</span><span class=\"token operator\">*</span> tmp <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>pages<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token comment\">//cprintf(\"temp %x %x %x\\n\", tmp, tmp->pgdir, tmp->vaddr);</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tmp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">//cprintf(\"tmp is zero\\n\");</span>\r\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token comment\">//cprintf(\"tmp is not zero\\n\");</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num_lru_pages <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      tmp<span class=\"token operator\">-></span>vaddr <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n      tmp<span class=\"token operator\">-></span>pgdir <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n      tmp<span class=\"token operator\">-></span>prev <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n      tmp<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n      page_lru_head <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">struct</span> <span class=\"token class-name\">page</span><span class=\"token operator\">*</span> prev_tmp <span class=\"token operator\">=</span> tmp<span class=\"token operator\">-></span>prev<span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">struct</span> <span class=\"token class-name\">page</span><span class=\"token operator\">*</span> next_tmp <span class=\"token operator\">=</span> tmp<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span>\r\n      prev_tmp<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> next_tmp<span class=\"token punctuation\">;</span>\r\n      next_tmp<span class=\"token operator\">-></span>prev <span class=\"token operator\">=</span> prev_tmp<span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tmp <span class=\"token operator\">==</span> page_lru_head<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n        page_lru_head <span class=\"token operator\">=</span> page_lru_head<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n\r\n      tmp<span class=\"token operator\">-></span>vaddr <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n      tmp<span class=\"token operator\">-></span>pgdir <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n      tmp<span class=\"token operator\">-></span>prev <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n      tmp<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token comment\">//print_lru();</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 함수는 deallocuvm(), manage_pages() 등에서 호출하여, LRU와 FREE PAGE를 관리하는 코드이다.\r\n우선 페이지가 새로 생기는 경우, 최로 LRU에 추가되는 상황이라면 비어있는 페이지 중에서 가장 앞에 있는 것을 찾은다음 pgdir과 va를 채워주고 page_lru_head 로 만든다. 그 다음부터 추가 될 경우 page_lru_head의 직전에 tail로 추가하게 된다. 물론 이때 prev와 next를 새롭게 연결해주게 된다.\r\n다음으로 기존의 페이지가 해제되는 경우, 해당하는 페이지를 우선 pages에 찾은다음 LRU에서 제거하게 된다. 여기서 LRU의 prev 와 next등을 재연결 해주고, 삭제한 페이지는 vaddr, pgdir, prev, next 값등을 0으로 만든다. 만약 head가 사라지게 될 경우에는 head 포인터를 다음으로 넘겨준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">reclaim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">//cprintf(\"\\nreclaim().... now head is : pgdir: %x pgaddr: %x --------------------- \\n\", page_lru_head->pgdir, page_lru_head->vaddr);</span>\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>num_lru_pages <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token comment\">//print_lru();</span>\r\n\r\n  <span class=\"token keyword\">int</span> find <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token class-name\">pte_t</span><span class=\"token operator\">*</span> pte<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> va<span class=\"token punctuation\">;</span>\r\n  <span class=\"token class-name\">pde_t</span><span class=\"token operator\">*</span> pgdir<span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>find<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n\r\n    va <span class=\"token operator\">=</span> page_lru_head<span class=\"token operator\">-></span>vaddr<span class=\"token punctuation\">;</span>\r\n    pgdir <span class=\"token operator\">=</span> page_lru_head<span class=\"token operator\">-></span>pgdir<span class=\"token punctuation\">;</span>\r\n    pte <span class=\"token operator\">=</span> <span class=\"token function\">walkpgdir</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">,</span> va<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte <span class=\"token operator\">&amp;</span> PTE_A<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 한번 넘어감</span>\r\n      <span class=\"token comment\">//cprintf(\"pgdir: %x pgaddr: %x is PTE_A ok .. pass\\n\", page_lru_head->pgdir, page_lru_head->vaddr);</span>\r\n      <span class=\"token operator\">*</span>pte <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span>PTE_A<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      page_lru_head <span class=\"token operator\">=</span> page_lru_head<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">//cprintf(\"pgdir: %x pgaddr: %x is PTE_A not ok .. find!\\n\", page_lru_head->pgdir, page_lru_head->vaddr);</span>\r\n      find <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">//evict 시작</span>\r\n  num_lru_pages<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\r\n  num_free_pages<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">page</span><span class=\"token operator\">*</span> old_head <span class=\"token operator\">=</span> page_lru_head<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">page</span><span class=\"token operator\">*</span> prev_head <span class=\"token operator\">=</span> page_lru_head<span class=\"token operator\">-></span>prev<span class=\"token punctuation\">;</span>\r\n  page_lru_head <span class=\"token operator\">=</span> page_lru_head<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span>\r\n\r\n  prev_head<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> page_lru_head<span class=\"token punctuation\">;</span>\r\n  page_lru_head<span class=\"token operator\">-></span>prev <span class=\"token operator\">=</span> prev_head<span class=\"token punctuation\">;</span>\r\n\r\n  pte <span class=\"token operator\">=</span> <span class=\"token function\">walkpgdir</span><span class=\"token punctuation\">(</span>old_head<span class=\"token operator\">-></span>pgdir<span class=\"token punctuation\">,</span> old_head<span class=\"token operator\">-></span>vaddr<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token comment\">//cprintf(\"old_head->pgdir: %x old_head->vaddr: %x\\n\",old_head->pgdir,old_head->vaddr);</span>\r\n\r\n  uint pa <span class=\"token operator\">=</span> <span class=\"token function\">PTE_ADDR</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">int</span> offset <span class=\"token operator\">=</span> <span class=\"token function\">find_free_offset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  bitmap<span class=\"token punctuation\">[</span>offset<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token comment\">//cprintf(\"offset: %x P2V(pa): %x\\n\",offset,P2V(pa));</span>\r\n  <span class=\"token function\">swapwrite</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">P2V</span><span class=\"token punctuation\">(</span>pa<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token function\">kfree</span><span class=\"token punctuation\">(</span><span class=\"token function\">P2V</span><span class=\"token punctuation\">(</span>pa<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token comment\">//cprintf(\"\\npte=%x\\n\", *pte);</span>\r\n\r\n  <span class=\"token operator\">*</span>pte <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span>PTE_P<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token operator\">*</span>pte <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xfff</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span>offset <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token comment\">//cprintf(\"\\npte=%x\\n\", *pte);</span>\r\n  old_head<span class=\"token operator\">-></span>vaddr <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  old_head<span class=\"token operator\">-></span>pgdir <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  old_head<span class=\"token operator\">-></span>prev <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  old_head<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token comment\">//print_lru();</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>reclaim() 함수에서는 kalloc에서 페이지가 모자랄때 여러 페이지 중 하나를 골라서 free한다. 여기서 evict 될 페이지는 LRU와 clock 알고리즘을 활용한다. 우선 num_lru_pages == 0 인 경우는 더이상 free가 불가능한 경우이므로 0을 리턴한다. 만약 LRU에 가능한 페이지들이 존재할 경우, page_lru_head 부터 순회하면서 <code class=\"language-text\">*pte &amp; PTE_A</code>를 확인한다. 만약 PTE_A가 설정되어 있는 경우 <code class=\"language-text\">*pte = ((*pte) &amp; (~PTE_A))</code> 를 통해서 PTE_A를 없애주고 다음 페이지로 head를 넘기며 탐색한다. 만약 PTE_A가 설정되어있지 않으면 해당 page를 evict 대상으로 선정하고 LRU에서 제거해 주는 과정을 거친다. 또한, bitmap을 설정해주고 swapwrite() 함수를 통해 해당 page를 스왑영역 블록에다가 쓰게 된다. 이때, <code class=\"language-text\">*pte = ((*pte) &amp; (~PTE_P))</code> 를 통해 PTE_P flag를 설정해주고 offset 까지 저장해준다.</p>\n<h4 id=\"5-trapc-수정\" style=\"position:relative;\"><a href=\"#5-trapc-%EC%88%98%EC%A0%95\" aria-label=\"5 trapc 수정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. trap.c 수정</h4>\n<p>trap.c의 경우에는, case T_PGFLT: 의 경우에 대하여 swapin기능을 구현한다. 여기서 rcr2()를 활용하며, PGFLT가 난 pte에 대하여 해당 page가 만약 swapwrite()를 통해 swapout 된 상황인지 판단하게된다. 만약 실제로 swapout이 된 경우라면, 기존에 저장했던 offset, PTE_P 등을 활용하여 읽어 들여야 하는 블록의 정보를 찾고 swapread()를 통해 읽어오게 된다.</p>\n<h2 id=\"source\" style=\"position:relative;\"><a href=\"#source\" aria-label=\"source permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Source</h2>\n<ul>\n<li>mit-pdos/xv6-public<br>\n<a href=\"https://github.com/mit-pdos/xv6-public\" target=\"_blank\" rel=\"nofollow\">https://github.com/mit-pdos/xv6-public</a></li>\n</ul>","id":"47266981-6eed-5f1c-81d0-b73466cce875","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EB%AA%A9%ED%91%9C\">목표</a></p>\n<ul>\n<li><a href=\"#fs-swapin-swapout-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\">FS swapin, swapout 구현하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B3%BC%EC%A0%95\">과정</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"#0-typesh-%EC%88%98%EC%A0%95\">0. types.h 수정</a></li>\n<li><a href=\"#1-defsh-%EC%88%98%EC%A0%95\">1. defs.h 수정</a></li>\n<li><a href=\"#2-mmuh-%EC%88%98%EC%A0%95\">2. mmu.h 수정</a></li>\n<li><a href=\"#3-vmc-%EC%88%98%EC%A0%95\">3. vm.c 수정</a></li>\n<li><a href=\"#4-kallocc-%EC%88%98%EC%A0%95\">4. kalloc.c 수정</a></li>\n<li><a href=\"#5-trapc-%EC%88%98%EC%A0%95\">5. trap.c 수정</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#source\">Source</a></p>\n</li>\n</ul>","frontmatter":{"title":"XV6 운영체제 개선해 보기 <swapin, swapout 구현하기>","summary":"XV6 운영체제의 구성을 알아보고 추가적인 기능을 도전해봅니다.","date":"2023.09.06.","categories":["OS"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA80lEQVQoz92SS0tCURSF/ZOBYN3buRmIgyKIIEgIx5LpfSgUFV2EizoTH/SUwMfAB1hOlPCnfLL1DLsozQrWYC043z777H0i7j6/VuR/wI4pEmPo6JrYe6INsGNSjFOwxN8m8RSeJfH+mIcTqRIOK/K7+GeM6rQfGTd4KtJyxExeqKZXvajwmz2Lqx2m78x6+Kd8vtItM6wz70uVm4R+UQisuI4ybbMYSfweMqjx4dOrMG5Sy5CNypkfYE+RixFc0K+KgpQAnYDKJV9vTJ4pnZOPhcB6YIfSvKv05AoH2AZ3RzI/29hiVdqvlrSOW63q73zPJU+/WoDmnxbZAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/0fe9f60f12a06de4130cb2f66fce12f1/55486/xv6.png","srcSet":"/static/0fe9f60f12a06de4130cb2f66fce12f1/ea722/xv6.png 200w,\n/static/0fe9f60f12a06de4130cb2f66fce12f1/f9bbb/xv6.png 400w,\n/static/0fe9f60f12a06de4130cb2f66fce12f1/55486/xv6.png 800w","sizes":"(min-width: 800px) 800px, 100vw"},"sources":[{"srcSet":"/static/0fe9f60f12a06de4130cb2f66fce12f1/4c856/xv6.webp 200w,\n/static/0fe9f60f12a06de4130cb2f66fce12f1/4dac1/xv6.webp 400w,\n/static/0fe9f60f12a06de4130cb2f66fce12f1/d0f18/xv6.webp 800w","type":"image/webp","sizes":"(min-width: 800px) 800px, 100vw"}]},"width":800,"height":600}},"publicURL":"/static/0fe9f60f12a06de4130cb2f66fce12f1/xv6.png"}}}}]}},"pageContext":{"slug":"/xv6_4/"}},"staticQueryHashes":[]}